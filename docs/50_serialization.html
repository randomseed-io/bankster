<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Serialization</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script><link rel="stylesheet" type="text/css" href="css/randomseed.css" /></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Bankster</span> <span class="project-version">2.2.2</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="10_introduction.html"><div class="inner"><span>Introduction</span></div></a></li><li class="depth-1 "><a href="11_sneak-peeks.html"><div class="inner"><span>Sneak peeks</span></div></a></li><li class="depth-1 "><a href="12_api.html"><div class="inner"><span>Bankster Front API</span></div></a></li><li class="depth-1 "><a href="15_contracts.html"><div class="inner"><span>Bankster Contracts</span></div></a></li><li class="depth-1 "><a href="20_data_structures.html"><div class="inner"><span>Data Structures</span></div></a></li><li class="depth-1 "><a href="30_currency-kinds.html"><div class="inner"><span>Currency kinds</span></div></a></li><li class="depth-1 "><a href="32_currency_traits.html"><div class="inner"><span>Currency traits</span></div></a></li><li class="depth-1 "><a href="50_example_config.html"><div class="inner"><span>Example EDN config</span></div></a></li><li class="depth-1  current"><a href="50_serialization.html"><div class="inner"><span>Serialization</span></div></a></li><li class="depth-1 "><a href="80_Apache-2-License.html"><div class="inner"><span>Apache License, v2.0</span></div></a></li><li class="depth-1 "><a href="85_LGPL-3-License.html"><div class="inner"><span>LGPL License, v3 or later</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>io</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>randomseed</span></div></div></li><li class="depth-3"><a href="io.randomseed.bankster.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bankster</span></div></a></li><li class="depth-4"><a href="io.randomseed.bankster.api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.api.currency.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>currency</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.api.money.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>money</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.api.ops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ops</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.api.registry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-5"><a href="io.randomseed.bankster.api.v2.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>v2</span></div></a></li><li class="depth-6 branch"><a href="io.randomseed.bankster.api.v2.currency.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>currency</span></div></a></li><li class="depth-6 branch"><a href="io.randomseed.bankster.api.v2.money.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>money</span></div></a></li><li class="depth-6 branch"><a href="io.randomseed.bankster.api.v2.ops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ops</span></div></a></li><li class="depth-6"><a href="io.randomseed.bankster.api.v2.registry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.config.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>config</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.currency.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>currency</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.init.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>init</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.jsr-354.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jsr-354</span></div></a></li><li class="depth-4"><a href="io.randomseed.bankster.money.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>money</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.money.inter-ops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>inter-ops</span></div></a></li><li class="depth-5"><a href="io.randomseed.bankster.money.ops.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ops</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.registry.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>registry</span></div></a></li><li class="depth-4 branch"><a href="io.randomseed.bankster.scale.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scale</span></div></a></li><li class="depth-4"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>serializers</span></div></div></li><li class="depth-5 branch"><a href="io.randomseed.bankster.serializers.common.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>common</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.serializers.edn.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>edn</span></div></a></li><li class="depth-5"><a href="io.randomseed.bankster.serializers.json.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>json</span></div></a></li><li class="depth-4"><a href="io.randomseed.bankster.util.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.util.fs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs</span></div></a></li><li class="depth-5 branch"><a href="io.randomseed.bankster.util.importer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>importer</span></div></a></li><li class="depth-5"><a href="io.randomseed.bankster.util.map.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>map</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#serialization" id="serialization"></a>Serialization</h1>
<p>Bankster provides per-format serialization protocols for JSON and EDN, with a clean separation between minimal and full representations.</p>
<h2><a href="#namespaces" id="namespaces"></a>Namespaces</h2>
<table>
<thead>
<tr><th> Namespace </th><th> Purpose </th></tr>
</thead>
<tbody>
<tr><td> <code>io.randomseed.bankster.serializers.json</code> </td><td> JSON serialization (strings for amounts, string IDs) </td></tr>
<tr><td> <code>io.randomseed.bankster.serializers.edn</code> </td><td> EDN serialization (BigDecimals, keyword IDs, tagged literals) </td></tr>
</tbody>
</table>
<h2><a href="#json-protocols" id="json-protocols"></a>JSON protocols</h2>
<pre><code class="language-clojure">(defprotocol JsonSerializable
  (to-json-map    [this] [this opts])   ; minimal or full map
  (to-json-full-map [this] [this opts]) ; always full map
  (to-json-string [this] [this opts]))  ; canonical string

(defprotocol JsonDeserializable
  (from-json-map    [type-token m] [type-token m opts])
  (from-json-string [type-token s] [type-token s opts]))
</code></pre>
<h2><a href="#edn-protocols" id="edn-protocols"></a>EDN protocols</h2>
<pre><code class="language-clojure">(defprotocol EdnSerializable
  (to-edn-map     [this] [this opts])   ; minimal or full map
  (to-edn-full-map [this] [this opts])  ; always full map
  (to-edn-string  [this] [this opts]))  ; tagged literal

(defprotocol EdnDeserializable
  (from-edn-map    [type-token m] [type-token m opts])
  (from-edn-string [type-token s] [type-token s opts]))
</code></pre>
<h2><a href="#minimal-vs-full-serialization" id="minimal-vs-full-serialization"></a>Minimal vs full serialization</h2>
<p>By default, serialization produces <strong>minimal</strong> output:</p>
<table>
<thead>
<tr><th> Type </th><th> JSON minimal </th><th> EDN minimal </th></tr>
</thead>
<tbody>
<tr><td> <code>Currency</code> </td><td> <code>{:id "PLN"}</code> </td><td> <code>{:id :PLN}</code> </td></tr>
<tr><td> <code>Money</code> </td><td> <code>{:currency "PLN", :amount "12.30"}</code> </td><td> <code>{:currency :PLN, :amount 12.30M}</code> </td></tr>
</tbody>
</table>
<p>Full serialization (<code>to-*-full-map</code> or <code>:full? true</code>) includes all fields:</p>
<table>
<thead>
<tr><th> Type </th><th> JSON full </th><th> EDN full </th></tr>
</thead>
<tbody>
<tr><td> <code>Currency</code> </td><td> <code>{:id, :numeric, :scale, :kind, :domain}</code> </td><td> <code>{:id, :numeric, :scale, :kind, :domain}</code> </td></tr>
<tr><td> <code>Money</code> </td><td> <code>{:currency {...}, :amount}</code> + extended fields </td><td> <code>{:currency {...}, :amount}</code> + extended fields </td></tr>
</tbody>
</table>
<h2><a href="#options" id="options"></a>Options</h2>
<table>
<thead>
<tr><th> Key </th><th> Type </th><th> Context </th><th> Description </th></tr>
</thead>
<tbody>
<tr><td> <code>:code-only?</code> </td><td> boolean </td><td> ser </td><td> Omit namespace: <code>:crypto/ETH</code> → <code>"ETH"</code> (JSON) / <code>:ETH</code> (EDN) </td></tr>
<tr><td> <code>:full?</code> </td><td> boolean </td><td> ser </td><td> Delegate <code>to-*-map</code> to <code>to-*-full-map</code> </td></tr>
<tr><td> <code>:keys</code> </td><td> vector </td><td> ser </td><td> Filter output keys; supports nested opts for recursive serialization </td></tr>
<tr><td> <code>:rescale</code> </td><td> integer </td><td> ser/deser </td><td> Scale to apply to amounts (see Rescaling section) </td></tr>
<tr><td> <code>:registry</code> </td><td> Registry </td><td> deser </td><td> Registry for deserialization (default: <code>registry/get</code>) </td></tr>
<tr><td> <code>:rounding-mode</code> </td><td> RoundingMode/keyword/string </td><td> ser/deser </td><td> Rounding mode for rescaling </td></tr>
</tbody>
</table>
<h3><a href="#rounding-mode-formats" id="rounding-mode-formats"></a>Rounding mode formats</h3>
<p>The <code>:rounding-mode</code> option accepts multiple formats: - <code>java.math.RoundingMode</code> object: <code>RoundingMode/HALF_UP</code> - Keyword: <code>:HALF_UP</code>, <code>:HALF_DOWN</code>, <code>:CEILING</code>, etc. - String: <code>"HALF_UP"</code>, <code>"ROUND_HALF_UP"</code></p>
<p>When not specified, falls back to <code>scale/*rounding-mode*</code> dynamic var.</p>
<h2><a href="#nested-keys-filtering" id="nested-keys-filtering"></a>Nested <code>:keys</code> filtering</h2>
<p>The <code>:keys</code> option supports nested options via map elements:</p>
<pre><code class="language-clojure">;; Filter Money to only :amount and currency's :id/:numeric
(to-json-full-map money {:keys [:amount {:currency {:keys [:id :numeric]}}]})
;; =&gt; {:amount "12.30", :currency {:id "PLN", :numeric 985}}
</code></pre>
<p>Syntax for <code>:keys</code> vector: - Keyword elements select that field without recursion - Map elements <code>{:field-name {:keys [...]}}</code> select that field with nested options</p>
<h2><a href="#extended-fields" id="extended-fields"></a>Extended fields</h2>
<p>Money records may carry extended fields (via <code>assoc</code>). Full serialization includes them:</p>
<pre><code class="language-clojure">(def m (assoc (money/of :PLN 100) :memo "Payment"))
(to-json-full-map m)
;; =&gt; {:currency {...}, :amount "100.00", :memo "Payment"}
</code></pre>
<p>Extended fields in JSON are stringified (BigDecimal → <code>.toPlainString</code>, keyword → <code>name</code>, other → <code>str</code>). In EDN they are preserved as-is.</p>
<h2><a href="#format-semantics" id="format-semantics"></a>Format semantics</h2>
<table>
<thead>
<tr><th> Aspect </th><th> JSON </th><th> EDN </th></tr>
</thead>
<tbody>
<tr><td> Currency ID </td><td> String (<code>"PLN"</code>, <code>"crypto/ETH"</code>) </td><td> Keyword (<code>:PLN</code>, <code>:crypto/ETH</code>) </td></tr>
<tr><td> Amount </td><td> String (<code>.toPlainString</code>) </td><td> BigDecimal </td></tr>
<tr><td> Tagged literal </td><td> N/A </td><td> <code>#money[12.30M PLN]</code>, <code>#money/crypto[1.5M ETH]</code> </td></tr>
<tr><td> Kind </td><td> String with namespace (<code>"iso/fiat"</code>) </td><td> Keyword with namespace (<code>:iso/fiat</code>) </td></tr>
<tr><td> Domain </td><td> String (<code>"ISO-4217"</code>) </td><td> Keyword (<code>:ISO-4217</code>) </td></tr>
</tbody>
</table>
<h2><a href="#convenience-functions" id="convenience-functions"></a>Convenience functions</h2>
<p>Both namespaces expose helper functions that mirror protocol methods:</p>
<pre><code class="language-clojure">;; JSON
(money-&gt;json-map m)          ; minimal
(money-&gt;json-full-map m)     ; full
(money-&gt;json-string m)       ; "12.30 PLN"
(json-map-&gt;money m)
(json-string-&gt;money s)
(currency-&gt;json-map c)       ; minimal {:id "PLN"}
(currency-&gt;json-full-map c)  ; full
(currency-&gt;json-string c)    ; "PLN"
(json-map-&gt;currency m)
(json-string-&gt;currency s)

;; EDN
(money-&gt;edn-map m)           ; minimal
(money-&gt;edn-full-map m)      ; full
(money-&gt;edn-string m)        ; "#money[12.30M PLN]"
(edn-map-&gt;money m)
(edn-string-&gt;money s)
(currency-&gt;edn-map c)        ; minimal {:id :PLN}
(currency-&gt;edn-full-map c)   ; full
(currency-&gt;edn-string c)     ; "#currency :PLN"
(edn-map-&gt;currency m)
(edn-string-&gt;currency s)
(edn-keyword-&gt;currency k)
</code></pre>
<h2><a href="#cheshire-integration-json" id="cheshire-integration-json"></a>Cheshire integration (JSON)</h2>
<pre><code class="language-clojure">(require '[io.randomseed.bankster.serializers.json :as sj])

;; Register Money encoder with Cheshire (map representation)
(sj/register-cheshire-codecs!)

;; Or use string representation
(sj/register-cheshire-codecs! {:representation :string})

;; With :code-only? option
(sj/register-cheshire-codecs! {:code-only? true})
</code></pre>
<p>Note: Cheshire registration affects encoding only. Decoding remains explicit via <code>json-map-&gt;money</code> / <code>json-string-&gt;money</code>.</p>
<h2><a href="#codec-helpers" id="codec-helpers"></a>Codec helpers</h2>
<p>Both namespaces provide <code>money-codec</code> for building encode/decode function pairs:</p>
<pre><code class="language-clojure">(let [{:keys [encode decode]} (sj/money-codec {:representation :map
                                               :code-only? true
                                               :registry my-reg
                                               :rounding-mode RoundingMode/HALF_UP})]
  (encode money)   ; -&gt; map or string
  (decode data))   ; -&gt; Money
</code></pre>
<p>The codec returns a map with: - <code>:encode</code> - function <code>(Money -&gt; json-value)</code> - <code>:decode</code> - function <code>(json-value -&gt; Money)</code> - <code>:representation</code> - <code>:map</code> or <code>:string</code></p>
<h2><a href="#usage-examples" id="usage-examples"></a>Usage examples</h2>
<h3><a href="#basic-serialization" id="basic-serialization"></a>Basic serialization</h3>
<pre><code class="language-clojure">(require '[io.randomseed.bankster.serializers.json :as sj]
         '[io.randomseed.bankster.serializers.edn  :as se])

;; JSON minimal (default)
(sj/money-&gt;json-map #money[12.30 PLN])
;; =&gt; {:currency "PLN", :amount "12.30"}

;; JSON full
(sj/money-&gt;json-full-map #money[12.30 PLN])
;; =&gt; {:currency {:id "PLN", :numeric 985, :scale 2, :kind "iso/fiat", :domain "ISO-4217"},
;;     :amount "12.30"}

;; EDN minimal
(se/money-&gt;edn-map #money[12.30 PLN])
;; =&gt; {:currency :PLN, :amount 12.30M}

;; EDN tagged literal
(se/money-&gt;edn-string #money[12.30 PLN])
;; =&gt; "#money[12.30M PLN]"

(se/money-&gt;edn-string #money/crypto[1.5 ETH])
;; =&gt; "#money/crypto[1.500000000000000000M ETH]"
</code></pre>
<h3><a href="#deserialization" id="deserialization"></a>Deserialization</h3>
<pre><code class="language-clojure">(sj/json-map-&gt;money {:currency "PLN" :amount "12.30"})
;; =&gt; #money[12.30 PLN]

(sj/json-string-&gt;money "12.30 PLN")
;; =&gt; #money[12.30 PLN]

(se/edn-string-&gt;money "#money[12.30M PLN]")
;; =&gt; #money[12.30 PLN]

;; With custom registry and rounding
(sj/json-map-&gt;money {:currency "PLN" :amount "1.005"}
                    {:rounding-mode java.math.RoundingMode/HALF_UP})
;; =&gt; #money[1.01 PLN]
</code></pre>
<h3><a href="#using-full-option" id="using-full-option"></a>Using :full? option</h3>
<pre><code class="language-clojure">;; Via to-json-map with :full? true
(sj/to-json-map #money[12.30 PLN] {:full? true})
;; =&gt; {:currency {:id "PLN", ...}, :amount "12.30"}

;; Via protocol
(sj/to-json-map (currency/of :PLN) {:full? true})
;; =&gt; {:id "PLN", :numeric 985, :scale 2, :kind "iso/fiat", :domain "ISO-4217"}
</code></pre>
<h3><a href="#filtering-with-keys" id="filtering-with-keys"></a>Filtering with :keys</h3>
<pre><code class="language-clojure">;; Select specific fields
(sj/money-&gt;json-full-map #money[12.30 PLN] {:keys [:amount {:currency {:keys [:id :numeric]}}]})
;; =&gt; {:amount "12.30", :currency {:id "PLN", :numeric 985}}

;; Currency only
(sj/currency-&gt;json-full-map (currency/of :PLN) {:keys [:id :scale]})
;; =&gt; {:id "PLN", :scale 2}
</code></pre>
<h3><a href="#code-only-mode" id="code-only-mode"></a>Code-only mode</h3>
<pre><code class="language-clojure">;; Omit namespace in currency IDs
(sj/money-&gt;json-map #money/crypto[1.5 ETH] {:code-only? true})
;; =&gt; {:currency "ETH", :amount "1.500000000000000000"}

(se/money-&gt;edn-string #money/crypto[1.5 ETH] {:code-only? true})
;; =&gt; "#money[1.500000000000000000M ETH]"
</code></pre>
<h3><a href="#rescaling" id="rescaling"></a>Rescaling</h3>
<p>The <code>:rescale</code> option allows serializing/deserializing Money with a different scale than the currency’s nominal scale.</p>
<h4><a href="#serialization-with-rescale" id="serialization-with-rescale"></a>Serialization with <code>:rescale</code></h4>
<p>Rescale amounts before outputting:</p>
<pre><code class="language-clojure">;; Upscale PLN (scale 2) to 4 decimal places
(sj/money-&gt;json-map #money[12.30 PLN] {:rescale 4})
;; =&gt; {:currency "PLN", :amount "12.3000"}

;; Downscale requires rounding mode (or throws ArithmeticException)
(sj/money-&gt;json-map #money/crypto[1.12345 ETH] {:rescale 2 :rounding-mode :HALF_UP})
;; =&gt; {:currency "crypto/ETH", :amount "1.12"}

;; Works with all serialization functions
(sj/money-&gt;json-string #money[12.30 PLN] {:rescale 4})
;; =&gt; "12.3000 PLN"
</code></pre>
<h4><a href="#deserialization-with-rescale" id="deserialization-with-rescale"></a>Deserialization with <code>:rescale</code></h4>
<p>Preserve precision when the incoming data has more decimal places than the registry currency. Without <code>:rescale</code>, the amount would be truncated to the currency’s nominal scale, potentially losing data.</p>
<pre><code class="language-clojure">;; PLN has scale 2, but incoming data has 4 decimal places
;; Without :rescale - data loss!
(sj/json-map-&gt;money {:currency "PLN" :amount "12.3456"})
;; =&gt; ArithmeticException (or truncated if rounding-mode set)

;; With :rescale - precision preserved
(sj/json-map-&gt;money {:currency "PLN" :amount "12.3456"} {:rescale 4})
;; =&gt; #money[12.3456 PLN] (Currency has scale 4, not the registry's 2)

;; The resulting Money has a Currency with the custom scale
(let [m (sj/json-map-&gt;money {:currency "PLN" :amount "12.3456"} {:rescale 4})]
  (.scale (currency/of m)))
;; =&gt; 4
</code></pre>
<h4><a href="#how-rescale-works-in-deserialization" id="how-rescale-works-in-deserialization"></a>How <code>:rescale</code> works in deserialization</h4>
<ol>
<li>Currency is looked up from the registry (by ID)</li>
<li>The Currency object is cloned with the <code>:rescale</code> value as its scale</li>
<li>Money is created with this modified Currency</li>
</ol>
<p>This means the resulting Money object carries a Currency with a non-standard scale. This is intentional - it preserves all information from the wire format without data loss.</p>
<h4><a href="#use-cases-for-rescale" id="use-cases-for-rescale"></a>Use cases for <code>:rescale</code></h4>
<ul>
<li><strong>APIs with variable precision</strong>: When external systems send amounts with more precision than your currency’s default scale</li>
<li><strong>Cross-system communication</strong>: When systems have different scale conventions</li>
<li><strong>Migration scenarios</strong>: When converting from one scale to another</li>
<li><strong>Display formatting</strong>: When you need amounts in a specific format for display</li>
</ul>
</div></div></div></body></html>